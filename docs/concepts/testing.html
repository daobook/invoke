
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Testing Invoke-using codebases &#8212; Invoke  文档</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/translations.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="Automatically responding to program output" href="watchers.html" />
    <link rel="prev" title="Constructing namespaces" href="namespaces.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="testing-invoke-using-codebases">
<span id="testing-user-code"></span><h1>Testing Invoke-using codebases<a class="headerlink" href="#testing-invoke-using-codebases" title="永久链接至标题">¶</a></h1>
<p>Strategies for testing codebases that use Invoke; some applicable to code
focused on CLI tasks, and others applicable to more generic/refactored setups.</p>
<section id="subclass-modify-invoke-internals">
<h2>Subclass &amp; modify Invoke ‘internals’<a class="headerlink" href="#subclass-modify-invoke-internals" title="永久链接至标题">¶</a></h2>
<p>A quick foreword: most users will find the subsequent approaches suitable, but
advanced users should note that Invoke has been designed so it is itself easily
testable. This means that in many cases, even Invoke’s “internals” are exposed
as low/no-shared-responsibility, publicly documented classes which can be
subclassed and modified to inject test-friendly values or mocks. Be sure to
look over the <a class="reference internal" href="../index.html#api"><span class="std std-ref">API documentation</span></a>!</p>
</section>
<section id="use-mockcontext">
<h2>Use <code class="xref py py-obj docutils literal notranslate"><span class="pre">MockContext</span></code><a class="headerlink" href="#use-mockcontext" title="永久链接至标题">¶</a></h2>
<p>An instance of subclassing Invoke’s public API for test purposes is our own
<code class="xref py py-obj docutils literal notranslate"><span class="pre">MockContext</span></code>. Codebases which revolve heavily around <code class="xref py py-obj docutils literal notranslate"><span class="pre">Context</span></code> objects and
their methods (most task-oriented code) will find it easy to test by injecting
<code class="xref py py-obj docutils literal notranslate"><span class="pre">MockContext</span></code> objects which have been instantiated to yield partial <code class="xref py py-obj docutils literal notranslate"><span class="pre">Result</span></code>
objects.</p>
<p>For example, take this task:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">task</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">get_platform</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">uname</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;uname -s&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">uname</span> <span class="o">==</span> <span class="s1">&#39;Darwin&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;You paid the Apple tax!&quot;</span>
    <span class="k">elif</span> <span class="n">uname</span> <span class="o">==</span> <span class="s1">&#39;Linux&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Year of Linux on the desktop!&quot;</span>
</pre></div>
</div>
<p>An example of testing it with <code class="xref py py-obj docutils literal notranslate"><span class="pre">MockContext</span></code> could be the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">MockContext</span><span class="p">,</span> <span class="n">Result</span>
<span class="kn">from</span> <span class="nn">mytasks</span> <span class="kn">import</span> <span class="n">get_platform</span>

<span class="k">def</span> <span class="nf">test_get_platform_on_mac</span><span class="p">():</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">MockContext</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="n">Result</span><span class="p">(</span><span class="s2">&quot;Darwin</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="s2">&quot;Apple&quot;</span> <span class="ow">in</span> <span class="n">get_platform</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_get_platform_on_linux</span><span class="p">():</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">MockContext</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="n">Result</span><span class="p">(</span><span class="s2">&quot;Linux</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="s2">&quot;desktop&quot;</span> <span class="ow">in</span> <span class="n">get_platform</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<section id="putting-the-mock-in-mockcontext">
<h3>Putting the <code class="docutils literal notranslate"><span class="pre">Mock</span></code> in <code class="xref py py-obj docutils literal notranslate"><span class="pre">MockContext</span></code><a class="headerlink" href="#putting-the-mock-in-mockcontext" title="永久链接至标题">¶</a></h3>
<p>Starting in Invoke 1.5, <code class="xref py py-obj docutils literal notranslate"><span class="pre">MockContext</span></code> will attempt to import the <code class="docutils literal notranslate"><span class="pre">mock</span></code>
library at instantiation time and wrap its methods within <code class="docutils literal notranslate"><span class="pre">Mock</span></code> objects.
This lets you not only present realistic return values to your code, but make
test assertions about what commands your code is running.</p>
<p>Here’s another “platform sensitive” task, being tested with the assumption that
the test environment has some flavor of <code class="docutils literal notranslate"><span class="pre">mock</span></code> installed (here we’ll pretend
it’s Python 3.6 or later, and also use some f-strings for brevity):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">task</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">replacement</span><span class="p">):</span>
    <span class="c1"># Assume systems have sed, and that some (eg macOS w/ Homebrew) may</span>
    <span class="c1"># have gsed, implying regular sed is BSD style.</span>
    <span class="n">has_gsed</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;which gsed&quot;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Set command to run accordingly</span>
    <span class="n">binary</span> <span class="o">=</span> <span class="s2">&quot;gsed&quot;</span> <span class="k">if</span> <span class="n">has_gsed</span> <span class="k">else</span> <span class="s2">&quot;sed&quot;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">binary</span><span class="si">}</span><span class="s2"> -e &#39;s/</span><span class="si">{</span><span class="n">search</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">replacement</span><span class="si">}</span><span class="s2">/g&#39; </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The test code (again, which presumes that eg <code class="docutils literal notranslate"><span class="pre">MockContext.run</span></code> is now a
<code class="docutils literal notranslate"><span class="pre">Mock</span></code> wrapper) relies primarily on ‘last call’ assertions
(<code class="docutils literal notranslate"><span class="pre">Mock.assert_called_with</span></code>) but you can of course use any <code class="docutils literal notranslate"><span class="pre">Mock</span></code> methods
you need. It also shows how you can set the mock context to respond to multiple
possible commands, using a dict value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">MockContext</span><span class="p">,</span> <span class="n">Result</span>
<span class="kn">from</span> <span class="nn">mytasks</span> <span class="kn">import</span> <span class="n">replace</span>

<span class="k">def</span> <span class="nf">test_regular_sed</span><span class="p">():</span>
    <span class="n">expected_sed</span> <span class="o">=</span> <span class="s2">&quot;sed -e s/foo/bar/g file.txt&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">MockContext</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;which gsed&quot;</span><span class="p">:</span> <span class="n">Result</span><span class="p">(</span><span class="n">exited</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">expected_sed</span><span class="p">:</span> <span class="n">Result</span><span class="p">(),</span>
    <span class="p">})</span>
    <span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">expected_sed</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_homebrew_gsed</span><span class="p">():</span>
    <span class="n">expected_sed</span> <span class="o">=</span> <span class="s2">&quot;gsed -e s/foo/bar/g file.txt&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">MockContext</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;which gsed&quot;</span><span class="p">:</span> <span class="n">Result</span><span class="p">(</span><span class="n">exited</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">expected_sed</span><span class="p">:</span> <span class="n">Result</span><span class="p">(),</span>
    <span class="p">})</span>
    <span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">expected_sed</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="boolean-mock-results">
<h3>Boolean mock results<a class="headerlink" href="#boolean-mock-results" title="永久链接至标题">¶</a></h3>
<p>You may have noticed the above example uses a handful of ‘empty’ <code class="xref py py-obj docutils literal notranslate"><span class="pre">Result</span></code>
objects; these stand in for “succeeded, but otherwise had no useful attributes”
command executions (as <code class="xref py py-obj docutils literal notranslate"><span class="pre">Result</span></code> defaults to an exit code of <code class="docutils literal notranslate"><span class="pre">0</span></code> and empty
strings for stdout/stderr).</p>
<p>This is relatively common - think “interrogative” commands where the caller
only cares for a boolean result, or times when a command is called purely for
its side effects. To support this, there’s a shorthand in <code class="xref py py-obj docutils literal notranslate"><span class="pre">MockContext</span></code>:
passing <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code> to stand in for otherwise blank Results with exit
codes of <code class="docutils literal notranslate"><span class="pre">0</span></code> or <code class="docutils literal notranslate"><span class="pre">1</span></code> respectively.</p>
<p>The example tests then look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">MockContext</span><span class="p">,</span> <span class="n">Result</span>
<span class="kn">from</span> <span class="nn">mytasks</span> <span class="kn">import</span> <span class="n">replace</span>

<span class="k">def</span> <span class="nf">test_regular_sed</span><span class="p">():</span>
    <span class="n">expected_sed</span> <span class="o">=</span> <span class="s2">&quot;sed -e s/foo/bar/g file.txt&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">MockContext</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;which gsed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">expected_sed</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">expected_sed</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_homebrew_gsed</span><span class="p">():</span>
    <span class="n">expected_sed</span> <span class="o">=</span> <span class="s2">&quot;gsed -e s/foo/bar/g file.txt&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">MockContext</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;which gsed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">expected_sed</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">expected_sed</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="string-mock-results">
<h3>String mock results<a class="headerlink" href="#string-mock-results" title="永久链接至标题">¶</a></h3>
<p>Another convenient shorthand is using string values, which are interpreted to
be the stdout of the resulting <code class="xref py py-obj docutils literal notranslate"><span class="pre">Result</span></code>. This only really saves you from
writing out the class itself (since <code class="docutils literal notranslate"><span class="pre">stdout</span></code> is the first positional arg of
<code class="xref py py-obj docutils literal notranslate"><span class="pre">Result</span></code>!) but “command X results in stdout Y” is a common enough use case
that we implemented it anyway.</p>
<p>By example, let’s modify an earlier example where we cared about stdout:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">MockContext</span>
<span class="kn">from</span> <span class="nn">mytasks</span> <span class="kn">import</span> <span class="n">get_platform</span>

<span class="k">def</span> <span class="nf">test_get_platform_on_mac</span><span class="p">():</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">MockContext</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="s2">&quot;Darwin</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;Apple&quot;</span> <span class="ow">in</span> <span class="n">get_platform</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_get_platform_on_linux</span><span class="p">():</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">MockContext</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="s2">&quot;Linux</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;desktop&quot;</span> <span class="ow">in</span> <span class="n">get_platform</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>As with everything else in this document, this tactic can be applied to
iterators or mappings as well as individual values.</p>
</section>
<section id="regular-expression-command-matching">
<h3>Regular expression command matching<a class="headerlink" href="#regular-expression-command-matching" title="永久链接至标题">¶</a></h3>
<p>The dict form of <code class="xref py py-obj docutils literal notranslate"><span class="pre">MockContext</span></code> kwarg can accept regular expression objects as
keys, in addition to strings; ideal for situations where you either don’t know
the exact command being invoked, or simply don’t need or want to write out the
entire thing.</p>
<p>Imagine you’re writing a function to run package management commands on a few
different Linux distros and you’re trying to test its error handling. You might
want to set up a context that pretends any arbitrary <code class="docutils literal notranslate"><span class="pre">apt</span></code> or <code class="docutils literal notranslate"><span class="pre">yum</span></code> command
fails, and ensure the function returns stderr when it encounters a problem:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">MockContext</span>
<span class="kn">from</span> <span class="nn">mypackage.tasks</span> <span class="kn">import</span> <span class="n">install</span>

<span class="n">package_manager</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(apt(-get)?|yum) .*&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_package_success_returns_True</span><span class="p">():</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">MockContext</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="p">{</span><span class="n">package_manager</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">install</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s2">&quot;somepackage&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">test_package_explosions_return_stderr</span><span class="p">():</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">MockContext</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="p">{</span>
        <span class="n">package_manager</span><span class="p">:</span> <span class="n">Result</span><span class="p">(</span><span class="n">stderr</span><span class="o">=</span><span class="s2">&quot;oh no!&quot;</span><span class="p">,</span> <span class="n">exited</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">})</span>
    <span class="k">assert</span> <span class="n">install</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s2">&quot;otherpackage&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;oh no!&quot;</span>
</pre></div>
</div>
<p>A bit contrived - there are a bunch of other ways to organize this exact test
code so you don’t truly need the regex - but hopefully it’s clear that when you
<em>do</em> need this flexibility, this is how you could go about it.</p>
</section>
<section id="repeated-results">
<h3>Repeated results<a class="headerlink" href="#repeated-results" title="永久链接至标题">¶</a></h3>
<p>By default, the values in these mock structures are consumed, causing
<code class="xref py py-obj docutils literal notranslate"><span class="pre">MockContext</span></code> to raise <code class="docutils literal notranslate"><span class="pre">NotImplementedError</span></code> afterwards (as it does for any
unexpected command executions). This was designed with the assumption that
most code under test will run a given command once.</p>
<p>If your situation doesn’t match this, give <code class="docutils literal notranslate"><span class="pre">repeat=True</span></code> to the constructor,
and you’ll see values repeat indefinitely instead (or in cycles, for
iterables).</p>
</section>
</section>
<section id="expect-results">
<h2>Expect <code class="xref py py-obj docutils literal notranslate"><span class="pre">Results</span></code><a class="headerlink" href="#expect-results" title="永久链接至标题">¶</a></h2>
<p>The core Invoke subprocess methods like <code class="xref py py-obj docutils literal notranslate"><span class="pre">run</span></code> all return <code class="xref py py-obj docutils literal notranslate"><span class="pre">Result</span></code>
objects - which (as seen above) can be readily instantiated by themselves with
only partial data (e.g. standard output, but no exit code or standard error).</p>
<p>This means that well-organized code can be even easier to test and doesn’t
require as much use of <code class="xref py py-obj docutils literal notranslate"><span class="pre">MockContext</span></code>.</p>
<p>An iteration on the initial <code class="xref py py-obj docutils literal notranslate"><span class="pre">MockContext</span></code>-using example above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">task</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">get_platform</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">platform_response</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;uname -s&quot;</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">platform_response</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">uname</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">uname</span> <span class="o">==</span> <span class="s1">&#39;Darwin&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;You paid the Apple tax!&quot;</span>
    <span class="k">elif</span> <span class="n">uname</span> <span class="o">==</span> <span class="s1">&#39;Linux&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Year of Linux on the desktop!&quot;</span>
</pre></div>
</div>
<p>With the logic encapsulated in a subroutine, you can just unit test that
function by itself, deferring testing of the task or its context:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">Result</span>
<span class="kn">from</span> <span class="nn">mytasks</span> <span class="kn">import</span> <span class="n">platform_response</span>

<span class="k">def</span> <span class="nf">test_platform_response_on_mac</span><span class="p">():</span>
    <span class="k">assert</span> <span class="s2">&quot;Apple&quot;</span> <span class="ow">in</span> <span class="n">platform_response</span><span class="p">(</span><span class="n">Result</span><span class="p">(</span><span class="s2">&quot;Darwin</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">test_platform_response_on_linux</span><span class="p">():</span>
    <span class="k">assert</span> <span class="s2">&quot;desktop&quot;</span> <span class="ow">in</span> <span class="n">platform_response</span><span class="p">(</span><span class="n">Result</span><span class="p">(</span><span class="s2">&quot;Linux</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="avoid-mocking-dependency-code-paths-altogether">
<h2>Avoid mocking dependency code paths altogether<a class="headerlink" href="#avoid-mocking-dependency-code-paths-altogether" title="永久链接至标题">¶</a></h2>
<p>This is more of a general software engineering tactic, but the natural endpoint
of the above code examples would be where your primary logic doesn’t care about
Invoke at all – only about basic Python (or locally defined) data types. This
allows you to test logic in isolation and either ignore testing the Invoke side
of things, or write targeted tests solely for where your code interfaces with
Invoke.</p>
<p>Another minor tweak to the task code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">task</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">show_platform</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">uname</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;uname -s&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">platform_response</span><span class="p">(</span><span class="n">uname</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">platform_response</span><span class="p">(</span><span class="n">uname</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">uname</span> <span class="o">==</span> <span class="s1">&#39;Darwin&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;You paid the Apple tax!&quot;</span>
    <span class="k">elif</span> <span class="n">uname</span> <span class="o">==</span> <span class="s1">&#39;Linux&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Year of Linux on the desktop!&quot;</span>
</pre></div>
</div>
<p>And the tests:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mytasks</span> <span class="kn">import</span> <span class="n">platform_response</span>

<span class="k">def</span> <span class="nf">test_platform_response_on_mac</span><span class="p">():</span>
    <span class="k">assert</span> <span class="s2">&quot;Apple&quot;</span> <span class="ow">in</span> <span class="n">platform_response</span><span class="p">(</span><span class="s2">&quot;Darwin</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_platform_response_on_linux</span><span class="p">():</span>
    <span class="k">assert</span> <span class="s2">&quot;desktop&quot;</span> <span class="ow">in</span> <span class="n">platform_response</span><span class="p">(</span><span class="s2">&quot;Linux</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Invoke</a></h1>



<p class="blurb">Pythonic task execution</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=pyinvoke&repo=invoke&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/pyinvoke/invoke">
    <img
        alt="https://secure.travis-ci.org/pyinvoke/invoke.svg?branch=master"
        src="https://secure.travis-ci.org/pyinvoke/invoke.svg?branch=master"
    />
</a>
</p>




    

<p>
<a class="badge" href="https://codecov.io/github/pyinvoke/invoke">
    <img
    alt="https://codecov.io/github/pyinvoke/invoke/coverage.svg?branch=master"
    src="https://codecov.io/github/pyinvoke/invoke/coverage.svg?branch=master"
    />
</a>
</p>
<h3>导航</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">快速入门</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../invoke.html"><code class="docutils literal notranslate"><span class="pre">inv[oke]</span></code> 核心用法</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="invoking-tasks.html">Invoking tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="library.html">Using Invoke as a library</a></li>
<li class="toctree-l1"><a class="reference internal" href="loading.html">Loading collections</a></li>
<li class="toctree-l1"><a class="reference internal" href="namespaces.html">Constructing namespaces</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Testing Invoke-using codebases</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#subclass-modify-invoke-internals">Subclass &amp; modify Invoke ‘internals’</a></li>
<li class="toctree-l2"><a class="reference internal" href="#use-mockcontext">Use <code class="xref py py-obj docutils literal notranslate"><span class="pre">MockContext</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#expect-results">Expect <code class="xref py py-obj docutils literal notranslate"><span class="pre">Results</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#avoid-mocking-dependency-code-paths-altogether">Avoid mocking dependency code paths altogether</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="watchers.html">Automatically responding to program output</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/__init__.html"><code class="docutils literal notranslate"><span class="pre">__init__</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/collection.html"><code class="docutils literal notranslate"><span class="pre">collection</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/config.html"><code class="docutils literal notranslate"><span class="pre">config</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/context.html"><code class="docutils literal notranslate"><span class="pre">context</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/exceptions.html"><code class="docutils literal notranslate"><span class="pre">exceptions</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/executor.html"><code class="docutils literal notranslate"><span class="pre">executor</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/loader.html"><code class="docutils literal notranslate"><span class="pre">loader</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/parser.html"><code class="docutils literal notranslate"><span class="pre">parser</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/program.html"><code class="docutils literal notranslate"><span class="pre">program</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/runners.html"><code class="docutils literal notranslate"><span class="pre">runners</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/tasks.html"><code class="docutils literal notranslate"><span class="pre">tasks</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/terminals.html"><code class="docutils literal notranslate"><span class="pre">terminals</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/util.html"><code class="docutils literal notranslate"><span class="pre">util</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/watchers.html"><code class="docutils literal notranslate"><span class="pre">watchers</span></code></a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://daobook.github.io/invoke">主页</a></li>
    
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>


<h3 class="donation">Donate/support</h3>







<p>
Professionally-supported Invoke is available with the
<a href="https://tidelift.com/subscription/pkg/pypi-invoke?utm_source=pypi-invoke&utm_medium=referral&utm_campaign=docs">Tidelift Subscription</a>.
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022 Jeff Forcier.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/concepts/testing.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-18486793-3']);
      _gaq.push(['_setDomainName', 'none']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    
  </body>
</html>