
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Configuration &#8212; Invoke  文档</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/translations.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="Invoking tasks" href="invoking-tasks.html" />
    <link rel="prev" title="inv[oke] core usage" href="../invoke.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="configuration">
<span id="id1"></span><h1>Configuration<a class="headerlink" href="#configuration" title="永久链接至标题">¶</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="永久链接至标题">¶</a></h2>
<p>Invoke offers a multifaceted configuration mechanism allowing you to configure
both core behavior and that of your tasks, via a hierarchy of configuration
files, environment variables, <a class="reference internal" href="namespaces.html"><span class="doc">task namespaces</span></a> and
CLI flags.</p>
<p>The end result of configuration seeking, loading, parsing &amp; merging is a
<code class="xref py py-obj docutils literal notranslate"><span class="pre">Config</span></code> object, which behaves like a (nested) Python dictionary. Invoke
references this object when it runs (determining the default behavior of
methods like <code class="xref py py-obj docutils literal notranslate"><span class="pre">Context.run</span></code>) and exposes it to users’ tasks as
<code class="xref py py-obj docutils literal notranslate"><span class="pre">Context.config</span></code> or as shorthand attribute access on the <code class="xref py py-obj docutils literal notranslate"><span class="pre">Context</span></code> itself.</p>
</section>
<section id="the-configuration-hierarchy">
<span id="config-hierarchy"></span><h2>The configuration hierarchy<a class="headerlink" href="#the-configuration-hierarchy" title="永久链接至标题">¶</a></h2>
<p>In brief, the order in which configuration values override one another is as
follows:</p>
<ol class="arabic">
<li><p><strong>Internal default values</strong> for behaviors which are controllable via
configuration. See <a class="reference internal" href="#default-values"><span class="std std-ref">Default configuration values</span></a> for details.</p></li>
<li><p><strong>Collection-driven configurations</strong> defined in tasks modules via
<code class="xref py py-obj docutils literal notranslate"><span class="pre">Collection.configure</span></code>. (See <a class="reference internal" href="#collection-configuration"><span class="std std-ref">Collection-based configuration</span></a> below for
details.)</p>
<blockquote>
<div><ul class="simple">
<li><p>Sub-collections’ configurations get merged into the top level collection
and the final result forms the basis of the overall configuration setup.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>System-level configuration file</strong> stored in <code class="docutils literal notranslate"><span class="pre">/etc/</span></code>, such as
<code class="docutils literal notranslate"><span class="pre">/etc/invoke.yaml</span></code>. (See <a class="reference internal" href="#config-files"><span class="std std-ref">Configuration files</span></a> for details on this and the
other config-file entries.)</p></li>
<li><p><strong>User-level configuration file</strong> found in the running user’s home
directory, e.g. <code class="docutils literal notranslate"><span class="pre">~/.invoke.yaml</span></code>.</p></li>
<li><p><strong>Project-level configuration file</strong> living next to your top level
<code class="docutils literal notranslate"><span class="pre">tasks.py</span></code>. For example, if your run of Invoke loads
<code class="docutils literal notranslate"><span class="pre">/home/user/myproject/tasks.py</span></code> (see our docs on <a class="reference internal" href="loading.html"><span class="doc">the load process</span></a>), this might be <code class="docutils literal notranslate"><span class="pre">/home/user/myproject/invoke.yaml</span></code>.</p></li>
<li><p><strong>Environment variables</strong> found in the invoking shell environment.</p>
<blockquote>
<div><ul class="simple">
<li><p>These aren’t as strongly hierarchical as the rest, nor is the shell
environment namespace owned wholly by Invoke, so we must rely on slightly
verbose prefixing instead - see <a class="reference internal" href="#env-vars"><span class="std std-ref">Environment variables</span></a> for details.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>Runtime configuration file</strong> whose path is given to <a class="reference internal" href="../invoke.html#cmdoption-f"><code class="xref std std-option docutils literal notranslate"><span class="pre">-f</span></code></a>, e.g.
<code class="docutils literal notranslate"><span class="pre">inv</span> <span class="pre">-f</span> <span class="pre">/random/path/to/config_file.yaml</span></code>. This path may also be set via the
<code class="docutils literal notranslate"><span class="pre">INVOKE_RUNTIME_CONFIG</span></code> env var.</p></li>
<li><p><strong>Command-line flags</strong> for certain core settings, such as <a class="reference internal" href="../invoke.html#cmdoption-e"><code class="xref std std-option docutils literal notranslate"><span class="pre">-e</span></code></a>.</p></li>
<li><p><strong>Modifications made by user code</strong> at runtime.</p></li>
</ol>
</section>
<section id="default-configuration-values">
<span id="default-values"></span><h2>Default configuration values<a class="headerlink" href="#default-configuration-values" title="永久链接至标题">¶</a></h2>
<p>Below is a list of all the configuration values and/or section Invoke itself
uses to control behaviors such as <code class="xref py py-obj docutils literal notranslate"><span class="pre">Context.run</span></code>’s <code class="docutils literal notranslate"><span class="pre">echo</span></code> and <code class="docutils literal notranslate"><span class="pre">pty</span></code>
flags, task deduplication, and so forth.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The storage location for these values is inside the <code class="xref py py-obj docutils literal notranslate"><span class="pre">Config</span></code> class,
specifically as the return value of <code class="xref py py-obj docutils literal notranslate"><span class="pre">Config.global_defaults</span></code>; see its API
docs for more details.</p>
</div>
<p>For convenience, we refer to nested setting names with a dotted syntax, so e.g.
<code class="docutils literal notranslate"><span class="pre">foo.bar</span></code> refers to what would be (in a Python config context) <code class="docutils literal notranslate"><span class="pre">{'foo':</span>
<span class="pre">{'bar':</span> <span class="pre">&lt;value</span> <span class="pre">here&gt;}}</span></code>. Typically, these can be read or set on <code class="xref py py-obj docutils literal notranslate"><span class="pre">Config</span></code> and
<code class="xref py py-obj docutils literal notranslate"><span class="pre">Context</span></code> objects using attribute syntax, which looks nearly identical:
<code class="docutils literal notranslate"><span class="pre">c.foo.bar</span></code>.</p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">tasks</span></code> config tree holds settings relating to task execution.</p>
<blockquote>
<div><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">tasks.dedupe</span></code> controls <a class="reference internal" href="invoking-tasks.html#deduping"><span class="std std-ref">Task deduplication</span></a> and defaults to <code class="docutils literal notranslate"><span class="pre">True</span></code>. It
can also be overridden at runtime via <a class="reference internal" href="../invoke.html#cmdoption-no-dedupe"><code class="xref std std-option docutils literal notranslate"><span class="pre">--no-dedupe</span></code></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tasks.auto_dash_names</span></code> controls whether task and collection names have
underscores turned to dashes on the CLI. Default: <code class="docutils literal notranslate"><span class="pre">True</span></code>. See also
<a class="reference internal" href="namespaces.html#dashes-vs-underscores"><span class="std std-ref">Dashes vs underscores</span></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tasks.collection_name</span></code> controls the Python import name sought out by
<a class="reference internal" href="loading.html#collection-discovery"><span class="std std-ref">collection discovery</span></a>, and defaults to
<code class="docutils literal notranslate"><span class="pre">&quot;tasks&quot;</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tasks.executor_class</span></code> allows users to override the class instantiated
and used for task execution.</p>
<p>Must be a fully-qualified dotted path of the form
<code class="docutils literal notranslate"><span class="pre">module(.submodule...).class</span></code>, where all but <code class="docutils literal notranslate"><span class="pre">.class</span></code> will be handed
to <a class="reference external" href="https://docs.python.org/3/library/importlib.html#importlib.import_module" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">importlib.import_module</span></code></a>, and <code class="docutils literal notranslate"><span class="pre">class</span></code> is expected to be an
attribute on that resulting module object.</p>
<p>Defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code>, meaning to use the running <code class="xref py py-obj docutils literal notranslate"><span class="pre">Program</span></code> object’s
<code class="docutils literal notranslate"><span class="pre">executor_class</span></code> attribute.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>Take care if using this setting in tandem with <a class="reference internal" href="library.html#reusing-as-a-binary"><span class="std std-ref">custom program
binaries</span></a>, since custom programs may specify
their own default executor class (which your use of this setting will
override!) and assume certain behaviors stemming from that.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">tasks.search_root</span></code> allows overriding the default <a class="reference internal" href="loading.html#collection-discovery"><span class="std std-ref">collection
discovery</span></a> root search location. It defaults to
<code class="docutils literal notranslate"><span class="pre">None</span></code>, which indicates to use the executing process’ current working
directory.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">run</span></code> tree controls the behavior of <code class="xref py py-obj docutils literal notranslate"><span class="pre">Runner.run</span></code>. Each member of this
tree (such as <code class="docutils literal notranslate"><span class="pre">run.echo</span></code> or <code class="docutils literal notranslate"><span class="pre">run.pty</span></code>) maps directly to a <code class="xref py py-obj docutils literal notranslate"><span class="pre">Runner.run</span></code>
keyword argument of the same name; see that method’s docstring for details on
what these settings do &amp; what their default values are.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">runners</span></code> tree controls _which_ runner classes map to which execution
contexts; if you’re using Invoke by itself, this will only tend to have a
single member, <code class="docutils literal notranslate"><span class="pre">runners.local</span></code>. Client libraries may extend it with
additional key/value pairs, such as <code class="docutils literal notranslate"><span class="pre">runners.remote</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">sudo</span></code> tree controls the behavior of <code class="xref py py-obj docutils literal notranslate"><span class="pre">Context.sudo</span></code>:</p>
<blockquote>
<div><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo.password</span></code> controls the autoresponse password submitted to sudo’s
password prompt. Default: <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>While it’s possible to store this setting, like any other, in
<a class="reference internal" href="#"><span class="doc">configuration files</span></a> – doing so is
inherently insecure. We highly recommend filling this config value in
at runtime from a secrets management system of some kind.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo.prompt</span></code> holds the sudo password prompt text, which is both
supplied to <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">-p</span></code>, and searched for when performing
<a class="reference internal" href="watchers.html"><span class="doc">auto-response</span></a>. Default: <code class="docutils literal notranslate"><span class="pre">[sudo]</span> <span class="pre">password:</span></code>.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>A top level config setting, <code class="docutils literal notranslate"><span class="pre">debug</span></code>, controls whether debug-level output is
logged; it defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">debug</span></code> can be toggled via the <a class="reference internal" href="../invoke.html#cmdoption-d"><code class="xref std std-option docutils literal notranslate"><span class="pre">-d</span></code></a> CLI flag, which enables
debugging after CLI parsing runs. It can also be toggled via the
<code class="docutils literal notranslate"><span class="pre">INVOKE_DEBUG</span></code> environment variable which - unlike regular env vars - is
honored from the start of execution and is thus useful for troubleshooting
parsing and/or config loading.</p>
</li>
<li><p>A small config tree, <code class="docutils literal notranslate"><span class="pre">timeouts</span></code>, holds various kinds of timeout controls.
At present, for Invoke, this only holds a <code class="docutils literal notranslate"><span class="pre">command</span></code> subkey, which controls
subprocess execution timeouts.</p>
<blockquote>
<div><ul class="simple">
<li><p>Client code often adds more to this tree, and Invoke itself may add more
in the future as well.</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</section>
<section id="configuration-files">
<span id="config-files"></span><h2>Configuration files<a class="headerlink" href="#configuration-files" title="永久链接至标题">¶</a></h2>
<section id="loading">
<h3>Loading<a class="headerlink" href="#loading" title="永久链接至标题">¶</a></h3>
<p>For each configuration file location mentioned in the previous section, we
search for files ending in <code class="docutils literal notranslate"><span class="pre">.yaml</span></code>, <code class="docutils literal notranslate"><span class="pre">.yml</span></code>, <code class="docutils literal notranslate"><span class="pre">.json</span></code> or <code class="docutils literal notranslate"><span class="pre">.py</span></code> (<strong>in that
order!</strong>), load the first one we find, and ignore any others that might exist.</p>
<p>For example, if Invoke is run on a system containing both <code class="docutils literal notranslate"><span class="pre">/etc/invoke.yml</span></code>
<em>and</em> <code class="docutils literal notranslate"><span class="pre">/etc/invoke.json</span></code>, <strong>only the YAML file will be loaded</strong>. This helps
keep things simple, both conceptually and in the implementation.</p>
</section>
<section id="format">
<h3>Format<a class="headerlink" href="#format" title="永久链接至标题">¶</a></h3>
<p>Invoke’s configuration allows arbitrary nesting, and thus so do our config file
formats. All three of the below examples result in a configuration equivalent
to <code class="docutils literal notranslate"><span class="pre">{'debug':</span> <span class="pre">True,</span> <span class="pre">'run':</span> <span class="pre">{'echo':</span> <span class="pre">True}}</span></code>:</p>
<ul>
<li><p><strong>YAML</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">debug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="nt">run</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">echo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><strong>JSON</strong></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;debug&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">&quot;run&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;echo&quot;</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p><strong>Python</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">run</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;echo&quot;</span><span class="p">:</span> <span class="kc">True</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
<p>For further details, see these languages’ own documentation.</p>
</section>
</section>
<section id="environment-variables">
<span id="env-vars"></span><h2>Environment variables<a class="headerlink" href="#environment-variables" title="永久链接至标题">¶</a></h2>
<p>Environment variables are a bit different from other configuration-setting
methods, since they don’t provide a clean way to nest configuration keys, and
are also implicitly shared amongst the entire system’s installed application
base.</p>
<p>In addition, due to implementation concerns, env vars must be pre-determined by
the levels below them in the config hierarchy (in other words - env vars may
only be used to override existing config values). If you need Invoke to
understand a <code class="docutils literal notranslate"><span class="pre">FOOBAR</span></code> environment variable, you must first declare a
<code class="docutils literal notranslate"><span class="pre">foobar</span></code> setting in a configuration file or in your task collections.</p>
<section id="basic-rules">
<h3>Basic rules<a class="headerlink" href="#basic-rules" title="永久链接至标题">¶</a></h3>
<p>To mitigate the shell namespace problem, we simply prefix all our env vars with
<code class="docutils literal notranslate"><span class="pre">INVOKE_</span></code>.</p>
<p>Nesting is performed via underscore separation, so a setting that looks like
e.g. <code class="docutils literal notranslate"><span class="pre">{'run':</span> <span class="pre">{'echo':</span> <span class="pre">True}}</span></code> at the Python level becomes
<code class="docutils literal notranslate"><span class="pre">INVOKE_RUN_ECHO=1</span></code> in a typical shell. See <a class="reference internal" href="#env-var-nesting"><span class="std std-ref">Nesting vs underscored names</span></a> below for
more on this.</p>
</section>
<section id="type-casting">
<h3>Type casting<a class="headerlink" href="#type-casting" title="永久链接至标题">¶</a></h3>
<p>Since env vars can only be used to override existing settings, the previous
value of a given setting is used as a guide in casting the strings we get back
from the shell:</p>
<ul>
<li><p>If the current value is a string or Unicode object, it is replaced with the
value from the environment, with no casting whatsoever;</p>
<blockquote>
<div><ul class="simple">
<li><p>Depending on interpreter and environment, this means that a setting
defaulting to a non-Unicode string type (eg a <code class="docutils literal notranslate"><span class="pre">str</span></code> on Python 2) may
end up replaced with a Unicode string, or vice versa. This is intentional
as it prevents users from accidentally limiting themselves to non-Unicode
strings.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>If the current value is <code class="docutils literal notranslate"><span class="pre">None</span></code>, it too is replaced with the string from the
environment;</p></li>
<li><p>Booleans are set as follows: <code class="docutils literal notranslate"><span class="pre">0</span></code> and the empty value/string (e.g.
<code class="docutils literal notranslate"><span class="pre">SETTING=</span></code>, or <code class="docutils literal notranslate"><span class="pre">unset</span> <span class="pre">SETTING</span></code>, or etc) evaluate to <code class="docutils literal notranslate"><span class="pre">False</span></code>, and any
other value evaluates to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p>Lists and tuples are currently unsupported and will raise an exception;</p>
<blockquote>
<div><ul class="simple">
<li><p>In the future we may implement convenience transformations, such as
splitting on commas to form a list; however since users can always
perform such operations themselves, it may not be a high priority.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>All other types - integers, longs, floats, etc - are simply used as
constructors for the incoming value.</p>
<blockquote>
<div><ul class="simple">
<li><p>For example, a <code class="docutils literal notranslate"><span class="pre">foobar</span></code> setting whose default value is the integer
<code class="docutils literal notranslate"><span class="pre">1</span></code> will run all env var inputs through <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">int</span></code></a>, and thus <code class="docutils literal notranslate"><span class="pre">FOOBAR=5</span></code>
will result in the Python value <code class="docutils literal notranslate"><span class="pre">5</span></code>, not <code class="docutils literal notranslate"><span class="pre">&quot;5&quot;</span></code>.</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</section>
<section id="nesting-vs-underscored-names">
<span id="env-var-nesting"></span><h3>Nesting vs underscored names<a class="headerlink" href="#nesting-vs-underscored-names" title="永久链接至标题">¶</a></h3>
<p>Since environment variable keys are single strings, we must use some form of
string parsing to allow access to nested configuration settings. As mentioned
above, in basic use cases this just means using an underscore character:
<code class="docutils literal notranslate"><span class="pre">{'run':</span> <span class="pre">{'echo':</span> <span class="pre">True}}</span></code> becomes <code class="docutils literal notranslate"><span class="pre">INVOKE_RUN_ECHO=1</span></code>.</p>
<p>However, ambiguity is introduced when the settings names themselves contain
underscores: is <code class="docutils literal notranslate"><span class="pre">INVOKE_FOO_BAR=baz</span></code> equivalent to <code class="docutils literal notranslate"><span class="pre">{'foo':</span> <span class="pre">{'bar':</span>
<span class="pre">'baz'}}</span></code>, or to <code class="docutils literal notranslate"><span class="pre">{'foo_bar':</span> <span class="pre">'baz'}</span></code>? Thankfully, because env vars can only
be used to modify settings declared at the Python level or in config files, we
look at the current state of the config to determine the answer.</p>
<p>There is still a corner case where <em>both</em> possible interpretations exist as
valid config paths (e.g. <code class="docutils literal notranslate"><span class="pre">{'foo':</span> <span class="pre">{'bar':</span> <span class="pre">'default'},</span> <span class="pre">'foo_bar':</span>
<span class="pre">'otherdefault'}</span></code>). In this situation, we honor the <a class="reference external" href="http://zen-of-python.info/in-the-face-of-ambiguity-refuse-the-temptation-to-guess.html#12">Zen of Python</a>
and refuse to guess; an error is raised instead, counseling users to modify
their configuration layout or avoid using env vars for the setting in question.</p>
</section>
</section>
<section id="collection-based-configuration">
<span id="collection-configuration"></span><h2><a class="reference internal" href="../api/collection.html#invoke.collection.Collection" title="invoke.collection.Collection"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Collection</span></code></a>-based configuration<a class="headerlink" href="#collection-based-configuration" title="永久链接至标题">¶</a></h2>
<p><a class="reference internal" href="../api/collection.html#invoke.collection.Collection" title="invoke.collection.Collection"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Collection</span></code></a> objects may contain a config mapping, set via
<code class="xref py py-obj docutils literal notranslate"><span class="pre">Collection.configure</span></code>, and (as per <a class="reference internal" href="#config-hierarchy"><span class="std std-ref">the hierarchy</span></a>)
this typically forms the lowest level of configuration in the system.</p>
<p>When collections are <a class="reference internal" href="namespaces.html"><span class="doc">nested</span></a>, configuration is
merged ‘downwards’ by default: when conflicts arise, outer namespaces closer to
the root will win, versus inner ones closer to the task being invoked.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>‘Inner’ tasks here are specifically those on the path from the root to the
one housing the invoked task. ‘Sibling’ subcollections are ignored.</p>
</div>
<p>A quick example of what this means:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">task</span>

<span class="c1"># This task &amp; collection could just as easily come from</span>
<span class="c1"># another module somewhere.</span>
<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">mytask</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;conflicted&#39;</span><span class="p">])</span>
<span class="n">inner</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">mytask</span><span class="p">)</span>
<span class="n">inner</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;conflicted&#39;</span><span class="p">:</span> <span class="s1">&#39;default value&#39;</span><span class="p">})</span>

<span class="c1"># Our project&#39;s root namespace.</span>
<span class="n">ns</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>
<span class="n">ns</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;conflicted&#39;</span><span class="p">:</span> <span class="s1">&#39;override value&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>The result of calling <code class="docutils literal notranslate"><span class="pre">inner.mytask</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ inv inner.mytask
override value
</pre></div>
</div>
</section>
<section id="example-of-real-world-config-use">
<h2>Example of real-world config use<a class="headerlink" href="#example-of-real-world-config-use" title="永久链接至标题">¶</a></h2>
<p>The previous sections had small examples within them; this section provides a
more realistic-looking set of examples showing how the config system works.</p>
<section id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="永久链接至标题">¶</a></h3>
<p>We’ll start out with semi-realistic tasks that hardcode their values, and build
up to using the various configuration mechanisms. A small module for building
<a class="reference external" href="http://sphinx-doc.org">Sphinx</a> docs might begin like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">task</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;rm -rf docs/_build&quot;</span><span class="p">)</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;sphinx-build docs docs/_build&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Then maybe you refactor the build target:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;docs/_build&quot;</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;rm -rf </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;sphinx-build docs </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
</pre></div>
</div>
<p>We can also allow runtime parameterization:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">default_target</span> <span class="o">=</span> <span class="s2">&quot;docs/_build&quot;</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">default_target</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;rm -rf </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">default_target</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;sphinx-build docs </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
</pre></div>
</div>
<p>This task module works for a single set of users, but what if we want to allow
reuse? Somebody may want to use this module with a different default target.
Using the configuration data (made available via the context arg) to configure
these settings is usually the better solution <a class="footnote-reference brackets" href="#id3" id="id2">1</a>.</p>
</section>
<section id="configuring-via-task-collection">
<h3>Configuring via task collection<a class="headerlink" href="#configuring-via-task-collection" title="永久链接至标题">¶</a></h3>
<p>The configuration <code class="xref py py-obj docutils literal notranslate"><span class="pre">setting</span></code> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">getting</span></code> APIs enable moving otherwise ‘hardcoded’ default values into
a config structure which downstream users are free to redefine. Let’s apply
this to our example. First we add an explicit namespace object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">task</span>

<span class="n">default_target</span> <span class="o">=</span> <span class="s2">&quot;docs/_build&quot;</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">default_target</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;rm -rf </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">default_target</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;sphinx-build docs </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

<span class="n">ns</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="n">clean</span><span class="p">,</span> <span class="n">build</span><span class="p">)</span>
</pre></div>
</div>
<p>Then we can move the default build target value into the collection’s default
configuration, and refer to it via the context. At this point we also change
our kwarg default value to be <code class="docutils literal notranslate"><span class="pre">None</span></code> so we can determine whether or not a
runtime value was given.  The result:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span>
<span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">sphinx</span><span class="o">.</span><span class="n">target</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;rm -rf </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">sphinx</span><span class="o">.</span><span class="n">target</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;sphinx-build docs </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

<span class="n">ns</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="n">clean</span><span class="p">,</span> <span class="n">build</span><span class="p">)</span>
<span class="n">ns</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;sphinx&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s2">&quot;docs/_build&quot;</span><span class="p">}})</span>
</pre></div>
</div>
<p>The result isn’t significantly more complex than what we began with, and as
we’ll see next, it’s now trivial for users to override your defaults in various
ways.</p>
</section>
<section id="configuration-overriding">
<h3>Configuration overriding<a class="headerlink" href="#configuration-overriding" title="永久链接至标题">¶</a></h3>
<p>The lowest-level override is, of course, just modifying the local <a class="reference internal" href="../api/collection.html#invoke.collection.Collection" title="invoke.collection.Collection"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Collection</span></code></a>
tree into which a distributed module has been imported. E.g. if the above
module is distributed as <code class="docutils literal notranslate"><span class="pre">myproject.docs</span></code>, someone can define a <code class="docutils literal notranslate"><span class="pre">tasks.py</span></code>
that does this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">myproject</span> <span class="kn">import</span> <span class="n">docs</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">mylocaltask</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="c1"># Some local stuff goes here</span>
    <span class="k">pass</span>

<span class="c1"># Add &#39;docs&#39; to our local root namespace, plus our own task</span>
<span class="n">ns</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="n">mylocaltask</span><span class="p">,</span> <span class="n">docs</span><span class="p">)</span>
</pre></div>
</div>
<p>And then they can add this to the bottom:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Our docs live in &#39;built_docs&#39;, not &#39;docs/_build&#39;</span>
<span class="n">ns</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;sphinx&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s2">&quot;built_docs&quot;</span><span class="p">}})</span>
</pre></div>
</div>
<p>Now we have a <code class="docutils literal notranslate"><span class="pre">docs</span></code> sub-namespace whose build target defaults to
<code class="docutils literal notranslate"><span class="pre">built_docs</span></code> instead of <code class="docutils literal notranslate"><span class="pre">docs/_build</span></code>. Runtime users can still override
this via flags (e.g. <code class="docutils literal notranslate"><span class="pre">inv</span> <span class="pre">docs.build</span> <span class="pre">--target='some/other/dir'</span></code>) just as
before.</p>
<p>If you prefer configuration files over in-Python tweaking of your namespace
tree, that works just as well; instead of adding the line above to the previous
snippet, instead drop this into a file next to <code class="docutils literal notranslate"><span class="pre">tasks.py</span></code> named
<code class="docutils literal notranslate"><span class="pre">invoke.yaml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sphinx</span><span class="p">:</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">built_docs</span>
</pre></div>
</div>
<p>For this example, that sort of local-to-project conf file makes the most sense,
but don’t forget that the <a class="reference internal" href="#config-hierarchy"><span class="std std-ref">config hierarchy</span></a> offers
additional configuration methods which may be suitable depending on your needs.</p>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="id3"><span class="brackets"><a class="fn-backref" href="#id2">1</a></span></dt>
<dd><p>Copying and modifying the file breaks code reuse; overriding the
module-level <code class="docutils literal notranslate"><span class="pre">default_path</span></code> variable won’t play well with concurrency;
wrapping the tasks with different default arguments works but is fragile
and adds boilerplate.</p>
</dd>
</dl>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Invoke</a></h1>



<p class="blurb">Pythonic task execution</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=pyinvoke&repo=invoke&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/pyinvoke/invoke">
    <img
        alt="https://secure.travis-ci.org/pyinvoke/invoke.svg?branch=master"
        src="https://secure.travis-ci.org/pyinvoke/invoke.svg?branch=master"
    />
</a>
</p>




    

<p>
<a class="badge" href="https://codecov.io/github/pyinvoke/invoke">
    <img
    alt="https://codecov.io/github/pyinvoke/invoke/coverage.svg?branch=master"
    src="https://codecov.io/github/pyinvoke/invoke/coverage.svg?branch=master"
    />
</a>
</p>
<h3>导航</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">快速入门</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../invoke.html"><code class="docutils literal notranslate"><span class="pre">inv[oke]</span></code> core usage</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-configuration-hierarchy">The configuration hierarchy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#default-configuration-values">Default configuration values</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-files">Configuration files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#environment-variables">Environment variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#collection-based-configuration"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Collection</span></code>-based configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-of-real-world-config-use">Example of real-world config use</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="invoking-tasks.html">Invoking tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="library.html">Using Invoke as a library</a></li>
<li class="toctree-l1"><a class="reference internal" href="loading.html">Loading collections</a></li>
<li class="toctree-l1"><a class="reference internal" href="namespaces.html">Constructing namespaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing Invoke-using codebases</a></li>
<li class="toctree-l1"><a class="reference internal" href="watchers.html">Automatically responding to program output</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/__init__.html"><code class="docutils literal notranslate"><span class="pre">__init__</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/collection.html"><code class="docutils literal notranslate"><span class="pre">collection</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/config.html"><code class="docutils literal notranslate"><span class="pre">config</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/context.html"><code class="docutils literal notranslate"><span class="pre">context</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/exceptions.html"><code class="docutils literal notranslate"><span class="pre">exceptions</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/executor.html"><code class="docutils literal notranslate"><span class="pre">executor</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/loader.html"><code class="docutils literal notranslate"><span class="pre">loader</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/parser.html"><code class="docutils literal notranslate"><span class="pre">parser</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/program.html"><code class="docutils literal notranslate"><span class="pre">program</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/runners.html"><code class="docutils literal notranslate"><span class="pre">runners</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/tasks.html"><code class="docutils literal notranslate"><span class="pre">tasks</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/terminals.html"><code class="docutils literal notranslate"><span class="pre">terminals</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/util.html"><code class="docutils literal notranslate"><span class="pre">util</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/watchers.html"><code class="docutils literal notranslate"><span class="pre">watchers</span></code></a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://daobook.github.io/invoke">Main website</a></li>
    
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>


<h3 class="donation">Donate/support</h3>







<p>
Professionally-supported Invoke is available with the
<a href="https://tidelift.com/subscription/pkg/pypi-invoke?utm_source=pypi-invoke&utm_medium=referral&utm_campaign=docs">Tidelift Subscription</a>.
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022 Jeff Forcier.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/concepts/configuration.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-18486793-3']);
      _gaq.push(['_setDomainName', 'none']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    
  </body>
</html>